---
title: 作用域
date: 2020-03-31 21:14:32
weight: 10
---

## 大纲

### let

1. let 的作用域在最近的`{}`之间
2. let 语法不允许在 let 声明该变量之前使用该变量
3. let 语法不允许重复声明一个相同的 let 变量
4. for 循环中的 `let = i` 作用域不会跑出循环

### const

- const 的其他特性与let相同
- const 只有一次赋值机会，并且声明时必须赋值

## 变量 let

### let 语法的由来 (相较于var的优点)

**声明变量的几种方式**

```js
// ES3 语法
a = 1  //
var a = 1
// ES6语法
let a = 1
const a = 1
```

**var 变量提升**

理论上下面的代码应该报错，并且不会a被声明

```js
function fn() {
    if(true){
        console.log(a)
    }else{
        var a 
        console.log(2)
    }
}
```

实际上上面的代码是这样执行的

```js
function fn() {
    var a
    if(true){
        console.log(a)
    }else{
        console.log(2)
    }
}
```

> var 变量提升只有在遇到函数时才会停止，其他作用域都无法阻止 var 的变量提升

**如何限制变量作用域**

```js
// ES6之前，使用立即执行函数
(function(){
    var a = 1
    window.sun = function(){
        console.log()
    }
}())

// ES6 语法，只需要在 {} 中使用let声明
{
    let a = 1
    window.sun = function(){
        console.log(a)
    }
}
```

### let 作用域

let 声明的变量，作用域只在`{}`中有效，例如：

```js
{
    let a = 1
}
console.log(a) // 报错，找不到变量 a
```

let 变量在声明之前无法使用（这个现象叫：Temp Dead Zone [临时死区] 就是在 let 声明之前的区域）

例1：

```js
{
    let a = 1
    {
        console.log(a) // 报错，无法在 let 声明之前使用该变量
        let a = 2
        {
            let a = 3
        }
    }
}
```

例2：

```js
if(true){
    let a = 1
    console.log(1)
}else {
    console.log(2)
}
console.log(a) // 报错，变量 a 不存在
```

let 变量无法重复声明，例如：

```js
{
    let a = 1
    let a = 2
    console.log(a) // 报错，无法重复声明变量
}
```

但 let 可以重新赋值

```js
{
    let a = 1
    a = 2
    console.log(a) // 输出：2
}
```

### for 循环中的 let

在 for 循环的括号中使用 let 声明的i也无法被 for 循环外部使用

```js
for(let i = 0; i < 5; i++) {
    console.log(i) // 打出 0 1 2 3 4
}
console.log(i) // 报错
```

## 常量 const 

const 声明一个常量，只允许赋值一次，无法修改。并且 const 声明必须赋值。

const 的其他特性与 let 都相同

例1

```js
{
    const a = 1
    a = 2
    console.log(a) // 报错，const 只有一次赋值机会
}
```

例2

```js
{
    const a // 报错，const 声明必须赋值
}
```

## 相关面试题

**1. 使用var声明一个变量 a，并添加一个函数，在函数中打出 a，如果在函数调用之前有一行未知代码，那么变量 a 的值有可能会受未知代码影响吗？**

```js
var a = 1
function fn(){
    console.log(a) // 1
}
xxx /* 这里有一行未知代码 */
fn()
```

假如在未知代码中重新赋值一个 a 变量，a 的值就会改变

```js
var a = 1
function fn(){
    console.log(a) // 1
}
a = 3 /* 未知代码 */
fn() // 输出：3
```

**2. for循环中使用var声明的变量 i 最终的值是多少**

```js
for(var i = 0; i < 6; i++){
    
}
console.log(i)
```

答案：

```js
var i
for(i = 0; i < 6; i++){
    // 0,1,2,3,4,5
}
// 当 i 等于 6 时，跳出循环，输出 i
console.log(i)
```

**3. 在 for 循环中存放一个函数，函数的内容是打出 i 的值。存放函数后调用.onclick方法执行该函数，那么该函数最后打出的结果是什么**

```js
var i
for(i = 0; i < 6; i++){
    function fn(){
        console.log('函数执行的i')
        console.log(i)
    }
    button.onclick = fn()// 点击事件调用该方法
}
console.log('最后输出的i')
console.log(i)
// 最后打出的 i 是多少
```

答案：

最终 i 会打出 6，因为 onclick 事件是在代码执行完成后执行的

JS Bin链接：https://jsbin.com/noselux/2/edit?html,js,output

### for循环中的 let 声明 i

onclick点击与循环结果：

如下代码点击 li 列表中的每一项打出的结果应该是多少

html

```html
<ul>
    <li>内容1</li>
    <li>内容2</li>
    <li>内容3</li>
    <li>内容4</li>
    <li>内容5</li>
    <li>内容6</li>
</ul>
```

JS

```js
var liList = document.querySelectorAll('li')

for(var i = 0; i < liList.length; i++) {
    liList[i].onclick = function(){
        console.log(i)
    }
}
console.log(i) // 输出 6
```

上面的代码输出的是 6，并且不论点击哪个 li 元素都会输出 6，这是因为onclick事件是在for循环执行完毕后才能触发的，因为只有在代码运行完成时才会显示页面，为了解决这个问题，可以：

修改其中的JS代码，将 i 改为用let声明的新变量 j (不能使用var声明，var声明变量会提升)

```js
var liList = document.querySelectorAll('li')

for(var i = 0; i < liList.length; i++) {
    let j = i
    liList[j].onclick = function(){
        console.log(j)
    }
}
```

此时点击每个列表将显示对应的 i 的值

JS Bin链接：https://jsbin.com/nawiqun/3/edit?html,js,output

上面的代码可以简化为：

```js
var liList = document.querySelectorAll('li')

for(let i = 0; i < liList.length; i++) {
    liList[i].onclick = function(){
        console.log(i)
    }
}
```

其中 `i` 的作用域就在 `for` 后面的 `()` 中，不会跑出去。但 for 循环的 `{}` 中每次循环都会自动声明一个一模一样的 `i` ，将 `()`中的 `i` 赋给 它。就像下面的代码，假如 `()` 中的 `i` 为 `_i`

```js
var liList = document.querySelectorAll('li')

for(let _i = 0; _i < liList.length; _i++) {
    /* 此处声明了 i0 i1 i2 i3 i4 i5 五个 i */
    let i = _i // 表示块级"{}"的i = 圆括号"()"中的 i 的值
    liList[i].onclick = function(){
        console.log(i)
    }
}
```

JS Bin链接：https://jsbin.com/nawiqun/4/edit?html,js,output

**ES6之前的写法**

JS部分

```js
var liList = document.querySelectorAll('li')

for(var i = 0; i < liList.length; i++) {
    // 在立即执行函数中传入 i 并将 j 声明在函数中，即可保证 j 不会变量提升
    (function(){
        var j = arguments[0]
        liList[j].onclick = function(){
            console.log(j)
        }
    })(i)
}
```
