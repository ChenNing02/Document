
## JSONP发请求

index.html

```html
<body>
    <p>你的账户余额为<span id="amount">&&&amount&&&</span></p>
    <button id="button">打钱</button>
    <script>
    button.addEventListener('click', (e)=>{
        let script = document.createElement('script')
        let functionName = 'chen'+parseInt(Math.random()*100000,10)
        window[functionName] = function(result){
            if(result === 'success'){
                amount.innerText = amount.innerText - 1
            }
        }
        script.src = 'http://ning.com:8002/pay?callback=' + functionName
        document.body.appendChild(script)
        script.onload = function(e){
            e.currentTarget.remove()
            delete window[functionName]
        }
        script.onerror = function(e){
            alert('fail')
            e.currentTarget.remove()
            delete window[functionName]
        }
    })
    </script>
</body>
```

server.js

```js
if(path === '/pay'/*  && method.toUpperCase() === 'POST' */){
    let amount = fs.readFileSync('./db', 'utf8')
    let newAmount = amount - 1
    fs.writeFileSync('./db', newAmount)
    response.setHeader('Content-Type', 'application/javascript')
    response.statusCode = 200
    response.write(`
		${query.callback}.call(undefined,'success')
    `)
    response.end()
}
```

**源代码链接**

https://github.com/ChenNing02/git-hunger/tree/master/JSONP/6_JSONP

## 使用原生JS发送AJAX请求

```js
let request = new XMLHttpRequest()
request.open('get', 'http://xxx.com')
request.send()
request.onreadystatechange = ()=>{
    if(request.readyState === 4){
        if(request.status >= 200 && request.status < 300){
            console.log('请求成功')
        }else if(request.status >= 400){
        	console.log('请求失败') 
      	}
    }
}
```



## 自制的Promise

### 封装

就是在原来的基础上 `return new Promise(function(resolve,reject){})`

将要做的事都放到Promise传入的函数中

函数的两个参数分别表示 成功调用的函数 和 失败调用的函数

封装的函数在调用时可以 `.then` 传入两个函数，这两个函数对应封装时的两个参数 `resolve, reject` ，分别表示 成功后执行的函数 和 失败后执行的函数。

`.then()` 是 Promise 对象特有的

```js
window.jQuery.ajax = function ({url, method, body, headers}){ 
    return new Promise(function(resolve,reject){
        let request = new XMLHttpRequest()
        request.open(method, url)  // 配置 request
        for(let key in headers){
            let value = headers[key]
            request.setRequestHeader(key,value)
        }
        request.onreadystatechange = ()=>{
            if(request.readyState === 4){
                if(request.status >= 200 && request.status < 300){
                    // 这里传入获取到的响应第四部分内容，当函数使用这个参数时，这就是回调函数
                    resolve.call(undefined,request.responseText) 
                }else if(request.status >= 400){
                    reject.call(undefined, request)
                }
            }
        }
        request.send(body)
    })
}
```

### 调用

```js
buttons.addEventListener('click', (e)=>{
    window.jQuery.ajax({
        url: '/xxx',
        method: 'POST',
        body: 'a=1&b=2',
        headers: {
            'content-type':'application/x-www-form-urlencoded',
            'chen':'16'
        }
    }).then(
        (text)=>{console.log(text)},
        (request)=>{console.log(request)}
    )    
})
```





